include:
  - project: tvconss/gitlab-tools
    ref: main
    file: sync-to-github/.gitlab-ci.yml

stages:
  - sync-to-github
  - deploy

variables:
  GITHUB_REPO: "aliconcon-ecommerce"

# Stage 2: Deploy to VPS (Docker Socket)
deploy_prod:
  stage: deploy
  image: docker:latest
  needs: []
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock   # Use VPS Docker Daemon
    DEPLOY_PATH: "/opt/apps/$CI_PROJECT_NAME"
  before_script:
    # Install rsync, git
    - apk add --no-cache rsync git

    # Setup CI_JOB_TOKEN for submodules access
    - git config --local url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.trancondev.site/".insteadOf "git@gitlab.trancondev.site:"

  script:
    # 1. Update Submodules
    - git submodule sync --recursive
    - git submodule update --init --recursive

    # 2. Prepare Directory
    - mkdir -p $DEPLOY_PATH

    # 3. Sync Files (Exclude .git to save space, but include submodules content)
    - rsync -av --delete --exclude '.git' ./ $DEPLOY_PATH/

    # 4. Deploy
    - cd $DEPLOY_PATH

    - docker compose down --remove-orphans || true
    - docker compose up -d --build

  only:
    - master

  tags:
    - docker
