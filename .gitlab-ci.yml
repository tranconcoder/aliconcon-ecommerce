include:
  - project: tvconss/gitlab-tools
    ref: main
    file: sync-to-github/.gitlab-ci.yml

stages:
  - sync-to-github
  - deploy

variables:
  GITHUB_REPO: "aliconcon-ecommerce"

# Stage 2: Deploy to VPS (Docker Socket)
deploy_prod:
  stage: deploy
  image: docker:latest
  needs: []
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock   # Use VPS Docker Daemon
    DEPLOY_PATH: "/opt/apps/$CI_PROJECT_NAME"
  before_script:
    # Install rsync, git, ssh (for submodules)
    - apk add --no-cache rsync git openssh-client

    # Setup SSH agent for submodules (if they are private/SSH)
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan gitlab.trancondev.site >> ~/.ssh/known_hosts

  script:
    # 1. Update Submodules
    - git submodule sync --recursive
    - git submodule update --init --recursive

    # 2. Prepare Directory
    - mkdir -p $DEPLOY_PATH

    # 3. Sync Files (Exclude .git to save space, but include submodules content)
    - rsync -av --delete --exclude '.git' ./ $DEPLOY_PATH/

    # 4. Deploy
    - cd $DEPLOY_PATH
    # Using docker-compose.yml (default) since docker-compose.prod.yml was not found
    # Add -f docker-compose.prod.yml if you create that file later
    - docker compose down --remove-orphans || true
    - docker compose up -d --build

  only:
    - master

  tags:
    - docker
